# -*- coding: utf-8 -*-
"""ReportCell â€” ì‹¤í—˜ ê²°ê³¼ ìë™ ë¦¬í¬íŒ….

ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ Markdown í˜•ì‹ì˜ ë¦¬í¬íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
ë°˜ë³µì ì¸ ì‹¤í—˜ ê²°ê³¼ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ê¸°ë¡í•˜ê³ , ì—°êµ¬ ë…¸íŠ¸(Lab Note)ë¡œ í™œìš©í•©ë‹ˆë‹¤.
"""

from __future__ import annotations

import datetime
from pathlib import Path
from typing import Any, Dict, List

import numpy as np
import pandas as pd

from engine.cells.base_cell import BaseCell
from engine.config import WhyLabConfig


class ReportCell(BaseCell):
    """ë¶„ì„ ê²°ê³¼ë¥¼ Markdown ë¦¬í¬íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” ì…€.

    Args:
        config: WhyLab ì „ì—­ ì„¤ì • ê°ì²´.
    """

    def __init__(self, config: WhyLabConfig) -> None:
        super().__init__(name="report_cell", config=config)

    def execute(self, inputs: Dict[str, Any]) -> Dict[str, Any]:
        """ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

        Args:
            inputs: ì´ì „ ì…€ë“¤ì˜ ëª¨ë“  ì¶œë ¥ (ATE, CATE, DataFrame ë“±).

        Returns:
            ìƒì„±ëœ ë¦¬í¬íŠ¸ íŒŒì¼ ê²½ë¡œ.
        """
        self.logger.info("ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘")

        # ë°ì´í„° ì¶”ì¶œ
        ate = inputs.get("ate", 0.0)
        ate_ci_lower = inputs.get("ate_ci_lower", 0.0)
        ate_ci_upper = inputs.get("ate_ci_upper", 0.0)
        cate_preds = inputs.get("cate_predictions", np.array([]))
        feature_names = inputs.get("feature_names", [])
        
        # ì„¸ê·¸ë¨¼íŠ¸ ë¶„ì„ ê²°ê³¼ (ExportCellë¡œì§ ì¬ì‚¬ìš© ë˜ëŠ” inputsì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        # ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ CATE í†µê³„ë§Œ ìš”ì•½
        cate_mean = float(np.mean(cate_preds)) if len(cate_preds) > 0 else 0.0
        cate_std = float(np.std(cate_preds)) if len(cate_preds) > 0 else 0.0

        # ë¦¬í¬íŠ¸ ë‚´ìš© ìƒì„±
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        scenario_name = inputs.get("scenario_name", "Unknown Scenario") # Pipelineì—ì„œ ì£¼ì… í•„ìš”
        
        report_content = self._generate_markdown(
            timestamp=timestamp,
            scenario=scenario_name,
            ate=ate,
            ci=(ate_ci_lower, ate_ci_upper),
            cate_stats={"mean": cate_mean, "std": cate_std},
            features=feature_names,
            n_samples=len(inputs.get("dataframe", []))
        )

        # íŒŒì¼ ì €ì¥
        output_dir = self.config.paths.reports_dir
        output_dir.mkdir(parents=True, exist_ok=True)
        
        filename = f"experiment_report_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
        file_path = output_dir / filename
        
        with open(file_path, "w", encoding="utf-8") as f:
            f.write(report_content)

        self.logger.info("ë¦¬í¬íŠ¸ ì €ì¥ ì™„ë£Œ: %s", file_path)

        return {
            "report_path": str(file_path),
            "report_content": report_content
        }

    def _generate_markdown(
        self,
        timestamp: str,
        scenario: str,
        ate: float,
        ci: tuple,
        cate_stats: Dict[str, float],
        features: List[str],
        n_samples: int
    ) -> str:
        """Markdown í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
        
        is_significant = not (ci[0] <= 0 <= ci[1])
        significance_text = "**í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•¨**" if is_significant else "í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•˜ì§€ ì•ŠìŒ"
        
        effect_direction = "ì¦ê°€" if ate > 0 else "ê°ì†Œ"
        
        return f"""# ğŸ§ª WhyLab Experiment Report

**Date**: {timestamp}
**Scenario**: {scenario}
**Samples**: {n_samples:,} samples
**Features**: {', '.join(features)}

---

## 1. Executive Summary

ë³¸ ì‹¤í—˜ì—ì„œëŠ” **{scenario}** ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•œ ì¸ê³¼ íš¨ê³¼ë¥¼ ì¶”ì •í–ˆìŠµë‹ˆë‹¤.
ë¶„ì„ ê²°ê³¼, ì²˜ì¹˜(Treatment)ëŠ” ê²°ê³¼ ë³€ìˆ˜(Outcome)ë¥¼ í‰ê· ì ìœ¼ë¡œ **{ate:.4f}** ë§Œí¼ **{effect_direction}**ì‹œí‚¤ëŠ” ê²ƒìœ¼ë¡œ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.
ì´ ê²°ê³¼ëŠ” 95% ì‹ ë¢°êµ¬ê°„ [{ci[0]:.4f}, {ci[1]:.4f}]ì„ ê³ ë ¤í•  ë•Œ {significance_text}ì…ë‹ˆë‹¤.

> **Key Finding**:
> ATE = {ate:.4f} (95% CI: {ci[0]:.4f} ~ {ci[1]:.4f})

---

## 2. Heterogeneity Analysis (CATE)

ê°œë³„ ì²˜ì¹˜ íš¨ê³¼(CATE)ì˜ ë¶„í¬ë¥¼ ë¶„ì„í•˜ì—¬ ì´ì§ˆì„±(Heterogeneity) ì¡´ì¬ ì—¬ë¶€ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.

- **Mean CATE**: {cate_stats['mean']:.4f}
- **Std Dev**: {cate_stats['std']:.4f}

{"**ğŸ’¡ Insight**: CATEì˜ í‘œì¤€í¸ì°¨ê°€ ì»¤ì„œ ì‚¬ìš©ìë³„ë¡œ íš¨ê³¼ ì°¨ì´ê°€ ëšœë ·í•©ë‹ˆë‹¤. íƒ€ê²ŸíŒ… ì •ì±… ìµœì í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤." if cate_stats['std'] > 0.01 else "íŠ¹ë³„í•œ ì´ì§ˆì„±ì´ ê´€ì°°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì „ì²´ ìœ ì €ì—ê²Œ ë™ì¼í•œ ì •ì±…ì„ ì ìš©í•´ë„ ë¬´ë°©í•©ë‹ˆë‹¤."}

---

## 3. Methodology Note

- **Model**: Double Machine Learning (DML)
- **Inference**: LinearDML / CausalForestDML
- **Cross-Validation**: 5-fold Cross-Fitting
- **Metric**: RMSE (Estimation), Coverage (Inference)

---

*Generated by WhyLab Engine*
"""
