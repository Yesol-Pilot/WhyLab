name: CI â€” Engine & Dashboard

on:
  push:
    branches: ["main"]
    paths:
      - "engine/**"
      - "whylab/**"
      - "dashboard/**"
      - "tests/**"
      - ".github/workflows/**"
      - "pyproject.toml"
  pull_request:
    branches: ["main"]

jobs:
  test-engine:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: engine/requirements.txt

      - name: Install Dependencies
        run: |
          pip install -e ".[dev]"
          pip install -r engine/requirements.txt
          pip install networkx statsmodels causal-learn || true

      - name: Run Unit Tests with Coverage
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m pytest tests/ -v --tb=short \
            --cov=engine --cov=whylab \
            --cov-report=term --cov-report=xml:coverage.xml \
            --cov-fail-under=80 \
            -k "not test_pipeline_e2e"

      - name: Run E2E Pipeline Tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m pytest tests/test_pipeline_e2e.py tests/test_integration.py tests/test_e2e_sprint5.py \
            -v --tb=short

      - name: Run Benchmark Smoke Test
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m engine.pipeline --benchmark ihdp --replications 1

  build-dashboard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: dashboard/package-lock.json

      - name: Install Dependencies
        working-directory: ./dashboard
        run: npm ci

      - name: Build Dashboard
        working-directory: ./dashboard
        run: npm run build
